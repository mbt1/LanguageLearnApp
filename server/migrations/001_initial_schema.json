{
  "operations": [
    {
      "sql": {
        "up": "-- Enums\nCREATE TYPE cefr_level AS ENUM ('A1', 'A2', 'B1', 'B2', 'C1', 'C2');\nCREATE TYPE concept_type AS ENUM ('vocabulary', 'grammar');\nCREATE TYPE exercise_type AS ENUM ('multiple_choice', 'cloze', 'reverse_typing', 'typing');\nCREATE TYPE fsrs_state AS ENUM ('learning', 'review', 'relearning');\nCREATE TYPE fsrs_rating AS ENUM ('again', 'hard', 'good', 'easy');\nCREATE TYPE dependency_source AS ENUM ('manual', 'auto');\n\n-- Trigger function for updated_at\nCREATE OR REPLACE FUNCTION set_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = now();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Users\nCREATE TABLE users (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    email text UNIQUE NOT NULL,\n    display_name text,\n    password_hash text,\n    created_at timestamptz NOT NULL DEFAULT now(),\n    updated_at timestamptz NOT NULL DEFAULT now()\n);\n\nCREATE TRIGGER trg_users_updated_at\n    BEFORE UPDATE ON users\n    FOR EACH ROW EXECUTE FUNCTION set_updated_at();\n\n-- User passkeys (WebAuthn)\nCREATE TABLE user_passkeys (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    credential_id bytea UNIQUE NOT NULL,\n    public_key bytea NOT NULL,\n    sign_count integer NOT NULL DEFAULT 0,\n    name text,\n    created_at timestamptz NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_user_passkeys_user ON user_passkeys(user_id);\n\n-- Courses\nCREATE TABLE courses (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    slug text UNIQUE NOT NULL,\n    title text NOT NULL,\n    source_language text NOT NULL,\n    target_language text NOT NULL,\n    created_at timestamptz NOT NULL DEFAULT now()\n);\n\n-- Concepts\nCREATE TABLE concepts (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    course_id uuid NOT NULL REFERENCES courses(id) ON DELETE CASCADE,\n    concept_type concept_type NOT NULL,\n    cefr_level cefr_level NOT NULL,\n    sequence integer NOT NULL,\n    prompt text NOT NULL,\n    target text NOT NULL,\n    explanation text,\n    created_at timestamptz NOT NULL DEFAULT now(),\n    UNIQUE (course_id, cefr_level, sequence)\n);\n\nCREATE INDEX idx_concepts_course_level ON concepts(course_id, cefr_level, sequence);\n\n-- Concept prerequisites\nCREATE TABLE concept_prerequisites (\n    concept_id uuid NOT NULL REFERENCES concepts(id) ON DELETE CASCADE,\n    prerequisite_id uuid NOT NULL REFERENCES concepts(id) ON DELETE CASCADE,\n    source dependency_source NOT NULL DEFAULT 'manual',\n    PRIMARY KEY (concept_id, prerequisite_id),\n    CHECK (concept_id != prerequisite_id)\n);\n\n-- Exercises\nCREATE TABLE exercises (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    concept_id uuid NOT NULL REFERENCES concepts(id) ON DELETE CASCADE,\n    exercise_type exercise_type NOT NULL,\n    prompt text NOT NULL,\n    correct_answer text NOT NULL,\n    distractors text[],\n    sentence_template text,\n    created_at timestamptz NOT NULL DEFAULT now(),\n    UNIQUE (concept_id, exercise_type)\n);\n\n-- User concept progress\nCREATE TABLE user_concept_progress (\n    user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    concept_id uuid NOT NULL REFERENCES concepts(id) ON DELETE CASCADE,\n    current_exercise_difficulty exercise_type NOT NULL DEFAULT 'multiple_choice',\n    consecutive_correct integer NOT NULL DEFAULT 0,\n    fsrs_state fsrs_state,\n    fsrs_step integer,\n    fsrs_stability double precision,\n    fsrs_difficulty double precision,\n    fsrs_due timestamptz,\n    fsrs_last_review timestamptz,\n    is_mastered boolean NOT NULL DEFAULT false,\n    created_at timestamptz NOT NULL DEFAULT now(),\n    updated_at timestamptz NOT NULL DEFAULT now(),\n    PRIMARY KEY (user_id, concept_id)\n);\n\nCREATE INDEX idx_ucp_user_due ON user_concept_progress(user_id, fsrs_due);\nCREATE INDEX idx_ucp_user_mastery ON user_concept_progress(user_id, is_mastered);\n\nCREATE TRIGGER trg_ucp_updated_at\n    BEFORE UPDATE ON user_concept_progress\n    FOR EACH ROW EXECUTE FUNCTION set_updated_at();\n\n-- Review history\nCREATE TABLE review_history (\n    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n    concept_id uuid NOT NULL REFERENCES concepts(id) ON DELETE CASCADE,\n    exercise_type exercise_type NOT NULL,\n    rating fsrs_rating NOT NULL,\n    response text,\n    correct boolean NOT NULL,\n    review_duration_ms integer,\n    reviewed_at timestamptz NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_review_history_user_concept ON review_history(user_id, concept_id, reviewed_at);",
        "down": "DROP TABLE IF EXISTS review_history;\nDROP TABLE IF EXISTS user_concept_progress;\nDROP TABLE IF EXISTS exercises;\nDROP TABLE IF EXISTS concept_prerequisites;\nDROP TABLE IF EXISTS concepts;\nDROP TABLE IF EXISTS courses;\nDROP TABLE IF EXISTS user_passkeys;\nDROP TABLE IF EXISTS users;\nDROP FUNCTION IF EXISTS set_updated_at;\nDROP TYPE IF EXISTS dependency_source;\nDROP TYPE IF EXISTS fsrs_rating;\nDROP TYPE IF EXISTS fsrs_state;\nDROP TYPE IF EXISTS exercise_type;\nDROP TYPE IF EXISTS concept_type;\nDROP TYPE IF EXISTS cefr_level;"
      }
    }
  ]
}
